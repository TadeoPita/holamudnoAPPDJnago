<!-- Token CSRF escondido para HTMX JS -->
<form style="display: none;">
  {% csrf_token %}
</form>

<div class="modal-header">
  <h5 class="modal-title">{{ tarea.titulo }}</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
  <p class="text-muted"><strong>Proyecto:</strong> {{ tarea.proyecto.nombre }}</p>
  <p><strong>DescripciÃ³n:</strong> {{ tarea.descripcion|default:"Sin descripciÃ³n" }}</p>
  <p><strong>Prioridad:</strong> {{ tarea.get_prioridad_display }}</p>
  <p><strong>Vencimiento:</strong> {{ tarea.fecha_vencimiento }}</p>
  <p><strong>Completada:</strong> {{ tarea.completada|yesno:"SÃ­,No" }}</p>

  <p><strong>Asignada a:</strong>
    {% for user in tarea.asignado_a.all %}
    {{ user.get_full_name|default:user.username }}{% if not forloop.last %}, {% endif %}
    {% empty %}
    <em>No asignado</em>
    {% endfor %}
  </p>

  <p><strong>Modificado por:</strong> {{ tarea.modificado_por }}</p>



  <hr style="color: #0054d3; border: solid 2px;">
  <h6>âœ… Checklist</h6>
  <ul class="list-group mb-3" id="checklist-list">
    {% for item in checklist %}
    {% include 'tarea/components/checklist_item.html' %}
    {% empty %}
    <li class="list-group-item text-muted">Sin Ã­tems</li>
    {% endfor %}
  </ul>

  {% if request.user in tarea.proyecto.usuarios_asignados.all %}
  <form hx-post="{% url 'agregar_checklist' tarea.id %}" hx-target="#checklist-list" hx-swap="beforeend" class="mb-3">
    {% csrf_token %}
    <div class="mb-2">
      {{ checklist_form.descripcion }}
    </div>
    <div class="mb-2">
      {{ checklist_form.asignado_a }}
    </div>
    <button type="submit" class="btn btn-purple">Agregar Ã­tem</button>
  </form>
  {% endif %}

  <hr style="color: #0054d3; border: solid 2px;">
  <h6>ðŸ’¬ Comentarios</h6>
  <ul class="list-group mb-3" id="comentarios-list">
    {% for comentario in comentarios %}
    {% include 'tarea/components/comentario_item.html' %}
    {% empty %}
    <li class="list-group-item text-muted">Sin comentarios aÃºn.</li>
    {% endfor %}
  </ul>

  {% if request.user in tarea.proyecto.usuarios_asignados.all %}
  <form hx-post="{% url 'agregar_comentario' tarea.id %}" hx-target="#comentarios-list" hx-swap="beforeend">
    {% csrf_token %}
    {{ comentario_form.texto }}
    <button type="submit" class="btn btn-purple mt-2">Comentar</button>
  </form>
  {% endif %}

  <hr style="color: #0054d3; border: solid 2px;">
  <h6>ðŸ“Ž Adjuntos</h6>
  <ul class="list-group mb-3" id="adjuntos-list">
    {% for adj in tarea.adjuntos.all %}
    {% include 'tarea/components/adjunto_item.html' with adj=adj %}
    {% empty %}
    <li class="list-group-item text-muted">Sin adjuntos</li>
    {% endfor %}
  </ul>

  {% if request.user in tarea.proyecto.usuarios_asignados.all or request.user.is_staff %}
  <form hx-post="{% url 'agregar_adjunto' tarea.id %}" hx-encoding="multipart/form-data" hx-target="#adjuntos-list"
    hx-swap="beforeend" enctype="multipart/form-data" method="POST" class="adjunto-form mt-2">
    {% csrf_token %}
    <div class="mb-2">
      {{ adjunto_form.archivo.label_tag }}
      {{ adjunto_form.archivo }}
    </div>

    <div class="mb-2">
      
      {{ adjunto_form.url.label_tag }}
      {{ adjunto_form.url }}
    </div>

    <button type="submit" class="btn btn-purple btn-sm">ðŸ“Ž Subir Adjunto</button>
  </form>
  {% endif %}

  <br><br>
  {% if request.user.is_staff %}
  <div class="d-flex gap-2 mb-3">
    <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-dark">Editar</a>
    <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-red">Eliminar</a>
  </div>
  {% endif %}
</div>
<script>
  document.body.addEventListener('htmx:configRequest', function (event) {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    if (token) {
      event.detail.headers['X-CSRFToken'] = token.value;
    }
  });
</script>