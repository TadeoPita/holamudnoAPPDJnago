<div class="modal-contenido">
  <div class="modal-cabecera">
    <div class="modal-cabecera-izquierda">
      <i class="fa-solid fa-list-check"></i>
      <span>Detalles de la Tarjeta</span>
    </div>
    <button class="cerrar-modal" onclick="cerrarModal()">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>

  <div class="modal-cuerpo">
    <div class="modal-columnas">
      <div class="modal-contenido-principal">
        <div class="modal-titulo-seccion">
          <h2 id="modal-titulo">{{ tarea.titulo }}</h2>
        </div>

        <!-- Metadatos -->
        <div class="modal-metadatos">
          <div class="modal-etiquetas">
            <span class="etiqueta-titulo">Etiquetas</span>
            <div class="etiquetas-lista">
              <span class="etiqueta-pill bg-success bg-gradient">Proyecto: {{ tarea.proyecto.nombre }}</span>
              <span class="etiqueta-pill bg-dark bg-gradient">Columna: {{ tarea.columna.nombre }}</span>
            </div>
          </div>

          <div class="modal-miembros">
            <span class="miembros-titulo">Asignado a</span>
            <div class="miembros-lista">
              {% for u in tarea.asignado_a.all %}
                <div class="miembro-avatar" title="{{ u.get_full_name|default:u.username }}">
                  {{ u.first_name|default:u.username|slice:":1" }}{{ u.last_name|slice:":1" }}
                </div>
              {% empty %}
                <span class="text-white">No asignado</span>
              {% endfor %}
            </div>
          </div>

          <div class="modal-fecha">
            <span class="fecha-titulo">Fecha LÃ­mite</span>
            <div class="fecha-valor">
              <i class="fa-solid fa-calendar-days"></i>
              <span class="text-white">{{ tarea.fecha_vencimiento|date:"d M" }}</span>
            </div>
          </div>
        </div>

        {% if user in tarea.puede_marcar_como_completada.all or user.is_staff %}
        <div class="text-end my-3">
          {% if not tarea.completada %}
          <button class="btn btn-success"
            hx-post="{% url 'marcar_como_completada' tarea.id %}"
            hx-target="#tarjetaModalContent"
            hx-swap="innerHTML"
            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
            hx-on::afterRequest="htmx.ajax('GET', '/tarea/{{ tarea.id }}/card_snippet/', '#tarea-card-{{ tarea.id }}')">
            âœ… Marcar como completada
          </button>
          {% else %}
          <span class="text-success">âœ… Tarea ya completada por {{ tarea.completada_por.get_full_name|default:tarea.completada_por.username }}</span>
          {% endif %}
        </div>
        {% endif %}

        <!-- DescripciÃ³n -->
        <div class="modal-seccion">
          <div class="seccion-encabezado">
            <i class="fa-solid fa-align-left"></i>
            <h3>DescripciÃ³n</h3>
          </div>
          <div class="seccion-contenido descripcion-contenido">
            <p>{{ tarea.descripcion|default:"Sin descripciÃ³n" }}</p>
          </div>
        </div>

        <!-- Checklist -->
        <div class="modal-seccion">
          <div class="seccion-encabezado seccion-encabezado-con-accion">
            <div class="seccion-titulo">
              <i class="fa-solid fa-check-square"></i>
              <h3>Checklist</h3>
            </div>
          </div>
          <ul class="list-group mb-3" id="checklist-list">
  {% include 'tarea/components/checklist_lista.html' with checklist=checklist %}
</ul>

          {% if request.user in tarea.proyecto.usuarios_asignados.all %}
          <form hx-post="{% url 'agregar_checklist' tarea.id %}"
                hx-target="#checklist-list"
                hx-swap="beforeend"
                hx-on::afterRequest="htmx.ajax('GET', '/tarea/{{ tarea.id }}/card_snippet/', '#tarea-card-{{ tarea.id }}'); checkEmptyList('#checklist-list', 'checklist-empty');">
            {% csrf_token %}
            <div class="mb-2">{{ checklist_form.descripcion }}</div>
            <div class="mb-2">{{ checklist_form.asignado_a }}</div>
            <button type="submit" class="btn btn-purple">Agregar Ã­tem</button>
          </form>
          {% endif %}
        </div>

        <!-- Comentarios -->
        <div class="modal-seccion">
          <div class="seccion-encabezado">
            <i class="fa-solid fa-comments"></i>
            <h3>Comentarios</h3>
          </div>
          <ul class="list-group mb-3" id="comentarios-list">
            <li class="list-group-item text-muted" id="comentarios-empty" {% if comentarios %}style="display:none;"{% endif %}>
              Sin comentarios aÃºn.
            </li>
            {% for comentario in comentarios %}
              {% include 'tarea/components/comentario_item.html' %}
            {% endfor %}
          </ul>
          {% if request.user in tarea.proyecto.usuarios_asignados.all %}
          <form hx-post="{% url 'agregar_comentario' tarea.id %}"
                hx-target="#comentarios-list"
                hx-swap="beforeend"
                hx-on::afterRequest="htmx.ajax('GET', '/tarea/{{ tarea.id }}/card_snippet/', '#tarea-card-{{ tarea.id }}'); checkEmptyList('#comentarios-list', 'comentarios-empty');">
            {% csrf_token %}
            {{ comentario_form.texto }}
            <button type="submit" class="btn btn-purple mt-2">Comentar</button>
          </form>
          {% endif %}
        </div>

        <!-- Adjuntos -->
        <div class="modal-seccion">
          <div class="seccion-encabezado seccion-encabezado-con-accion">
            <div class="seccion-titulo">
              <i class="fa-solid fa-paperclip"></i>
              <h3>Adjuntos</h3>
            </div>
          </div>
          <ul class="list-group mb-3" id="adjuntos-list">
            <li class="list-group-item text-muted" id="adjuntos-empty"
              {% if tarea.adjuntos.all|length > 0 %}style="display:none;"{% endif %}>
              Sin adjuntos
            </li>
            {% for adj in tarea.adjuntos.all %}
              {% include 'tarea/components/adjunto_item.html' with adj=adj %}
            {% endfor %}
          </ul>
          {% if request.user in tarea.proyecto.usuarios_asignados.all or request.user.is_staff %}
          <form hx-post="{% url 'agregar_adjunto' tarea.id %}"
                hx-encoding="multipart/form-data"
                hx-target="#adjuntos-list"
                hx-swap="beforeend"
                hx-on::afterRequest="htmx.ajax('GET', '/tarea/{{ tarea.id }}/card_snippet/', '#tarea-card-{{ tarea.id }}'); checkEmptyList('#adjuntos-list', 'adjuntos-empty');"
                enctype="multipart/form-data" method="POST" class="adjunto-form mt-2">
            {% csrf_token %}
            <div class="mb-2">{{ adjunto_form.archivo.label_tag }}{{ adjunto_form.archivo }}</div>
            <div class="mb-2">{{ adjunto_form.url.label_tag }}{{ adjunto_form.url }}</div>
            <button type="submit" class="btn btn-purple btn-sm">ðŸ“Ž Subir Adjunto</button>
          </form>
          {% endif %}
        </div>

        {% if request.user.is_staff %}
        <div class="d-flex gap-2 mb-3">
          <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-dark">Editar</a>
          <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-red">Eliminar</a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  function checkEmptyList(containerSelector, emptyId) {
    const container = document.querySelector(containerSelector);
    const emptyItem = document.getElementById(emptyId);
    if (!container || !emptyItem) return;

    const visibleItems = container.querySelectorAll("li:not(#" + emptyId + ")");
    emptyItem.style.display = visibleItems.length === 0 ? "" : "none";
  }

  document.body.addEventListener("htmx:afterSwap", function () {
    checkEmptyList("#checklist-list", "checklist-empty");
    checkEmptyList("#comentarios-list", "comentarios-empty");
    checkEmptyList("#adjuntos-list", "adjuntos-empty");
  });

  document.body.addEventListener("htmx:afterSettle", function () {
    checkEmptyList("#checklist-list", "checklist-empty");
    checkEmptyList("#adjuntos-list", "adjuntos-empty");
    checkEmptyList("#comentarios-list", "comentarios-empty");
  });
</script>
